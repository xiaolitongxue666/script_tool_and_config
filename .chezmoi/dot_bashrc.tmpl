{{- if ne .chezmoi.os "darwin" -}}
# Bash ç»Ÿä¸€é…ç½®æ–‡ä»¶
# è‡ªåŠ¨æ£€æµ‹æ“ä½œç³»ç»Ÿå¹¶åŠ è½½å¯¹åº”é…ç½®
# æ³¨æ„ï¼šmacOS ä½¿ç”¨ .bash_profileï¼Œæ­¤æ–‡ä»¶ä¸é€‚ç”¨äºŽ macOS

# ============================================
# ç³»ç»Ÿæ£€æµ‹
# ============================================
if [[ "$OSTYPE" == "darwin"* ]]; then
    OS="macos"
elif [[ "$OSTYPE" == "linux-gnu"* ]]; then
    OS="linux"
elif [[ "$OSTYPE" == "msys" ]] || [[ "$OSTYPE" == "cygwin" ]]; then
    OS="windows"
else
    OS="unknown"
fi

# ============================================
# é€šç”¨é…ç½®ï¼ˆæ‰€æœ‰å¹³å°ï¼‰
# ============================================

# ============================================
# ä»£ç†é…ç½®ï¼ˆç»Ÿä¸€é…ç½®ï¼Œå‚è€ƒ Git Bashï¼‰
# ============================================
# é»˜è®¤ä»£ç†åœ°å€ï¼šLinux ä¸‹è‡ªåŠ¨åŒºåˆ† WSL2 ä¸ŽåŽŸç”Ÿï¼ˆWSL2 ä¸­ 127.0.0.1 æ— æ³•è®¿é—®å®¿ä¸»æœºï¼Œéœ€ç”¨ /etc/resolv.conf çš„ nameserverï¼‰
if [[ "$OSTYPE" == "linux-gnu"* ]]; then
    if grep -qEi "Microsoft|WSL" /proc/version 2>/dev/null || [[ -n "${WSL_DISTRO_NAME:-}" ]]; then
        _proxy_host=$(cat /etc/resolv.conf 2>/dev/null | grep nameserver | awk '{print $2}')
        PROXY_DEFAULT="http://${_proxy_host:-127.0.0.1}:7890"
    else
        PROXY_DEFAULT="http://127.0.0.1:7890"
    fi
else
    PROXY_DEFAULT="{{ env "http_proxy" | default "http://127.0.0.1:7890" }}"
fi
PROXY_URL="${PROXY:-${http_proxy:-$PROXY_DEFAULT}}"

# ä»£ç†æŽ§åˆ¶åˆ«åï¼ˆåŒæ—¶è®¾ç½®å¤§å°å†™çŽ¯å¢ƒå˜é‡ï¼Œç¡®ä¿æ‰€æœ‰å·¥å…·éƒ½èƒ½è¯†åˆ«ï¼‰
# h_proxy: å¿«é€Ÿå¯ç”¨ä»£ç†
alias h_proxy='export http_proxy='"$PROXY_URL"'; export https_proxy='"$PROXY_URL"'; export HTTP_PROXY='"$PROXY_URL"'; export HTTPS_PROXY='"$PROXY_URL"'; export all_proxy='"$PROXY_URL"'; export ALL_PROXY='"$PROXY_URL"'; echo "ä»£ç†å·²å¯ç”¨: $PROXY_URL"'
# unset_h: å…³é—­ä»£ç†ï¼ˆæ¸…é™¤æ‰€æœ‰ä»£ç†çŽ¯å¢ƒå˜é‡ï¼‰
alias unset_h='unset http_proxy; unset https_proxy; unset HTTP_PROXY; unset HTTPS_PROXY; unset all_proxy; unset ALL_PROXY; echo "ä»£ç†å·²å…³é—­"'
# WSL å¸¸ç”¨å‘½åï¼šproxy_on / proxy_off ä¸Ž h_proxy / unset_h ç­‰ä»·
alias proxy_on='h_proxy'
alias proxy_off='unset_h'

# é»˜è®¤å¯ç”¨ä»£ç†ï¼ˆå¯é€‰ï¼Œå–æ¶ˆæ³¨é‡Šä»¥è‡ªåŠ¨å¯ç”¨ï¼‰
# h_proxy

# Bat instead cat
if command -v bat &> /dev/null; then
    alias cat='bat'
fi

# ============================================
# å¹³å°ç‰¹å®šé…ç½®
# ============================================

# macOS ç‰¹å®šé…ç½®
if [[ "$OS" == "macos" ]]; then
    # æ·»åŠ ç”¨æˆ·ç§æœ‰ shell è·¯å¾„
    export PATH=$PATH:/Users/liyong/Code/Tools/Shells/BashTools

    # SDKMANï¼ˆå¿…é¡»åœ¨æ–‡ä»¶æœ«å°¾ï¼‰
    export SDKMAN_DIR="/Users/liyong/.sdkman"
    [[ -s "/Users/liyong/.sdkman/bin/sdkman-init.sh" ]] && source "/Users/liyong/.sdkman/bin/sdkman-init.sh"

    # è·¯å¾„é…ç½®
    export PATH="/Applications/Postgres.app/Contents/Versions/latest/bin:$PATH"
    export PATH="/Users/liyong/Library/Python/2.7/bin:$PATH"
    export PATH=$PATH':/path/to/add'
    export PATH="/usr/local/bin:$PATH"
    export PATH="/usr/local/opt/make/libexec/gnubin:$PATH"

    # GEM é…ç½®
    export GEM_HOME=$HOME/.gem
    export GEM_PATH=$HOME/.gem

    # fnm (Fast Node Manager) - ä¸Ž dot_bash_profile ä¸€è‡´ï¼Œä¿æŒæ¨¡æ¿è¯­ä¹‰ç»Ÿä¸€
    if [ -d "{{ .chezmoi.homeDir }}/.local/share/fnm" ]; then
        export PATH="{{ .chezmoi.homeDir }}/.local/share/fnm:$PATH"
        if command -v fnm >/dev/null 2>&1; then
            eval "$(fnm env --shell=bash --use-on-cd)"
            if [ -f "$HOME/.node-version" ]; then
                NODE_VERSION=$(cat "$HOME/.node-version" 2>/dev/null | tr -d '\n\r' | sed 's/^v//')
                if [ -n "$NODE_VERSION" ]; then
                    fnm use "$NODE_VERSION" 2>/dev/null || true
                fi
            fi
        fi
    elif [ -d "{{ .chezmoi.homeDir }}/.fnm" ]; then
        export PATH="{{ .chezmoi.homeDir }}/.fnm:$PATH"
        if command -v fnm >/dev/null 2>&1; then
            eval "$(fnm env --shell=bash --use-on-cd)"
            if [ -f "$HOME/.node-version" ]; then
                NODE_VERSION=$(cat "$HOME/.node-version" 2>/dev/null | tr -d '\n\r' | sed 's/^v//')
                if [ -n "$NODE_VERSION" ]; then
                    fnm use "$NODE_VERSION" 2>/dev/null || true
                fi
            fi
        fi
    fi

    # Cargo
    if [ -f "$HOME/.cargo/env" ]; then
        . "$HOME/.cargo/env"
    fi

# Windows ç‰¹å®šé…ç½®ï¼ˆGit Bash/MSYS2ï¼‰
elif [[ "$OS" == "windows" ]]; then
    # History
    PROMPT_COMMAND='history -a'

    # ä»£ç†é…ç½®ï¼ˆWindows ä½¿ç”¨å®Œæ•´é…ç½®ï¼Œå‚è€ƒ Git Bashï¼‰
    # æ³¨æ„ï¼šWindows Git Bash çš„è¯¦ç»†ä»£ç†é…ç½®åœ¨ .bash_profile ä¸­
    # è¿™é‡Œåªè®¾ç½®åŸºæœ¬å˜é‡ï¼Œ.bash_profile ä¸­æœ‰å®Œæ•´çš„ curl åŒ…è£…å‡½æ•°
    PROXY_URL="${PROXY:-{{ env "http_proxy" | default "http://127.0.0.1:7890" }}}"
    export http_proxy="$PROXY_URL"
    export https_proxy="$PROXY_URL"
    export HTTP_PROXY="$PROXY_URL"
    export HTTPS_PROXY="$PROXY_URL"
    export all_proxy="$PROXY_URL"
    export ALL_PROXY="$PROXY_URL"

    # opencode é…ç½®
    # å¦‚æžœ opencode å·²å®‰è£…ï¼Œæ·»åŠ åˆ° PATH
    if [ -d "/c/opencode" ]; then
        export PATH="/c/opencode:$PATH"
    fi

    # ç½‘ç»œæ£€æŸ¥åˆ«å
    alias check_network='curl -IL https://www.google.com 2>/dev/null | grep -q -E "200 OK|Connection established" && echo "Network is OK" || echo "Network is down"'

    # Explorer
    alias open='explorer'

    # Docker å·¥ä½œåŒºï¼ˆWindows Git Bashï¼‰
    docker() {
        (export MSYS_NO_PATHCONV=1; "docker.exe" "$@")
    }

    # Docker Compose å·¥ä½œåŒºï¼ˆWindows Git Bashï¼‰
    docker-compose() {
        (export MSYS_NO_PATHCONV=1; "docker-compose.exe" "$@")
    }

    # éžç™»å½• shell ä¸‹ç¡®ä¿èƒ½æ‰¾åˆ° oh-my-posh/starshipï¼ˆä¸Ž run_on_windows/dot_bash_profile çš„ PATH ä¸€è‡´ï¼‰
    for _d in "$HOME/AppData/Local/Microsoft/WinGet/Links" "$HOME/AppData/Local/Programs/oh-my-posh"; do
        [ -d "$_d" ] && [[ ":$PATH:" != *":$_d:"* ]] && export PATH="$PATH:$_d"
    done
    unset _d

    # Windows æç¤ºç¬¦ï¼šä»…ç”¨ Oh My Poshï¼ˆä¸Ž run_on_windows/dot_bash_profile ä¸€è‡´ï¼Œé¿å…ç™»å½•/éžç™»å½•æ˜¾ç¤ºä¸åŒï¼‰
    _omp_config="$HOME/AppData/Local/Programs/oh-my-posh/themes/montys.omp.json"
    if command -v oh-my-posh &> /dev/null; then
        if [ -f "$_omp_config" ]; then
            eval "$(oh-my-posh --init --shell bash --config "$_omp_config")"
        else
            eval "$(oh-my-posh --init --shell bash)"
        fi
    elif command -v starship &> /dev/null; then
        eval "$(starship init bash)"
    fi
    unset _omp_config

    # æ‰“å¼€é»˜è®¤è·¯å¾„
    cd /d/Code 2>/dev/null || cd ~

    # å¯åŠ¨æ—¶æ˜¾ç¤ºæ¬¢è¿Žä¿¡æ¯
    echo "Welcome! ðŸ˜Š"

# Linux ç‰¹å®šé…ç½®
elif [[ "$OS" == "linux" ]]; then
    # ç”¨æˆ·æœ¬åœ° binï¼ˆchezmoiã€uvã€lazygit ç­‰ï¼‰ä¸Ž cargoï¼Œä¸Ž .zprofile å¯¹é½ï¼Œç¡®ä¿ç™»å½•/è‡ªå¯åŠ¨åŽå¯ç”¨
    export PATH="{{ .chezmoi.homeDir }}/.local/bin:{{ .chezmoi.homeDir }}/.cargo/bin:$PATH"
    # Debian/Ubuntu: bat åŒ…æä¾› batcatï¼Œfd-find åŒ…æä¾› fdfindï¼Œç»Ÿä¸€ä¸º bat/fd å‘½ä»¤
    if command -v batcat &>/dev/null && ! command -v bat &>/dev/null; then alias bat=batcat; fi
    if command -v fdfind &>/dev/null && ! command -v fd &>/dev/null; then alias fd=fdfind; fi
    # fnm (Fast Node Manager) - Node.js ç‰ˆæœ¬ç®¡ç†ï¼ˆä»… Linuxï¼Œä¸å½±å“ Windowsï¼‰
    # å‚è€ƒ: https://github.com/Schniz/fnm
    if [ -d "{{ .chezmoi.homeDir }}/.local/share/fnm" ]; then
        export PATH="{{ .chezmoi.homeDir }}/.local/share/fnm:$PATH"
        if command -v fnm >/dev/null 2>&1; then
            eval "$(fnm env --shell=bash --use-on-cd)"
            if [ -f "$HOME/.node-version" ]; then
                NODE_VERSION=$(cat "$HOME/.node-version" 2>/dev/null | tr -d '\n\r' | sed 's/^v//')
                if [ -n "$NODE_VERSION" ]; then
                    fnm use "$NODE_VERSION" 2>/dev/null || true
                fi
            fi
        fi
    elif [ -d "{{ .chezmoi.homeDir }}/.fnm" ]; then
        export PATH="{{ .chezmoi.homeDir }}/.fnm:$PATH"
        if command -v fnm >/dev/null 2>&1; then
            eval "$(fnm env --shell=bash --use-on-cd)"
            if [ -f "$HOME/.node-version" ]; then
                NODE_VERSION=$(cat "$HOME/.node-version" 2>/dev/null | tr -d '\n\r' | sed 's/^v//')
                if [ -n "$NODE_VERSION" ]; then
                    fnm use "$NODE_VERSION" 2>/dev/null || true
                fi
            fi
        fi
    fi
    # Cursor/VS Code è¿žæŽ¥ WSL æ—¶é»˜è®¤å¯èƒ½å¯åŠ¨ bashï¼›äº¤äº’å¼ä¸‹è‡ªåŠ¨åˆ‡åˆ° zsh ä»¥åŠ è½½ Starshipï¼ˆAgent æ¨¡å¼ä¿ç•™ bashï¼‰
    if [[ -o interactive ]] && [[ -z "${CURSOR_AGENT:-}" ]] && command -v zsh &>/dev/null; then
        exec zsh
    fi
fi
{{- end -}}

