{{- if eq .chezmoi.os "linux" -}}
#!/bin/bash

# ============================================
# Alacritty 终端安装脚本（chezmoi run_once_）
# 仅 Linux；macOS 使用 Ghostty（run_on_darwin/run_once_install-ghostty）
# ============================================

# 获取 common_install.sh 路径
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="${CHEZMOI_PROJECT_ROOT:-$(cd "${SCRIPT_DIR}/../.." && pwd 2>/dev/null || echo "$HOME")}"
COMMON_INSTALL="${PROJECT_ROOT}/scripts/chezmoi/common_install.sh"

if [ ! -f "$COMMON_INSTALL" ]; then
    COMMON_INSTALL="$HOME/.local/share/chezmoi/scripts/chezmoi/common_install.sh"
fi

# 加载通用函数库
if [ -f "$COMMON_INSTALL" ]; then
    source "$COMMON_INSTALL"
else
    echo "[WARNING] 未找到 common_install.sh，使用基本函数"
    function setup_proxy() { :; }
    function detect_os_and_package_manager() {
        OS="$(uname -s)"
        if [[ "$OS" == "Darwin" ]]; then
            PLATFORM="macos"
            PACKAGE_MANAGER="brew"
        elif [[ "$OS" == "Linux" ]]; then
            PLATFORM="linux"
            if command -v pacman &> /dev/null; then
                PACKAGE_MANAGER="pacman"
            elif command -v apt-get &> /dev/null; then
                PACKAGE_MANAGER="apt"
            fi
        fi
    }
    function install_package() {
        local pkg="$1"
        if [[ "$PACKAGE_MANAGER" == "brew" ]]; then
            brew install --cask "$pkg"
        elif [[ "$PACKAGE_MANAGER" == "pacman" ]]; then
            sudo pacman -S --noconfirm "$pkg"
        elif [[ "$PACKAGE_MANAGER" == "apt" ]]; then
            sudo apt-get update && sudo apt-get install -y "$pkg"
        fi
    }
fi

# 设置代理
setup_proxy "${PROXY:-{{ env "http_proxy" | default "http://127.0.0.1:7890" }}}"

# 检测操作系统和包管理器
detect_os_and_package_manager || exit 1

# 检查 Alacritty 是否已安装
if command -v alacritty &> /dev/null; then
    echo "[INFO] Alacritty 已安装: $(alacritty --version | head -n 1)"
    exit 0
fi

echo "[INFO] 开始安装 Alacritty..."

# 根据包管理器安装（仅 Linux）
case "$PLATFORM" in
    linux)
        if [[ "$PACKAGE_MANAGER" == "pacman" ]]; then
            install_package "alacritty"
        elif [[ "$PACKAGE_MANAGER" == "apt" ]]; then
            # Ubuntu/Debian 需要添加 PPA 或使用 snap
            echo "[INFO] 对于 Ubuntu/Debian，建议使用 snap 或从源码编译"
            echo "[INFO] snap install alacritty"
            echo "[INFO] 或参考: https://github.com/alacritty/alacritty/blob/master/INSTALL.md"
        fi
        ;;
    *)
        echo "[ERROR] 不支持的操作系统"
        exit 1
        ;;
esac

if command -v alacritty &> /dev/null; then
    echo "[SUCCESS] Alacritty 安装成功: $(alacritty --version | head -n 1)"
else
    echo "[WARNING] Alacritty 可能未正确安装，请手动检查"
fi
{{- end -}}

