{{- if or (eq .chezmoi.os "linux") (eq .chezmoi.os "darwin") (eq .chezmoi.os "windows") -}}
# ============================================
# Zsh 登录 Shell 环境变量配置
# 所有登录方式（本地登录、SSH 登录）都会读取此文件
# ============================================
# 注意：此文件在 .zshrc 之前加载，用于设置环境变量
# 参考: https://zsh.sourceforge.io/Intro/intro_3.html

# ============================================
# 基础 PATH 配置
# ============================================
# 基础路径（本地本来就有的）
export PATH="{{ .chezmoi.homeDir }}/.local/bin:{{ .chezmoi.homeDir }}/.cargo/bin:$PATH"

# 系统路径（根据操作系统添加）
{{ if eq .chezmoi.os "linux" }}
# Linux 特定路径
export PATH="/usr/local/bin:$PATH"
export PATH="/usr/local/opt/make/libexec/gnubin:$PATH"
{{ else if eq .chezmoi.os "darwin" }}
# macOS 特定路径
if [ -f /opt/homebrew/bin/brew ]; then
    eval "$(/opt/homebrew/bin/brew shellenv)"
elif [ -f /usr/local/bin/brew ]; then
    eval "$(/usr/local/bin/brew shellenv)"
fi
{{ else if eq .chezmoi.os "windows" }}
# Windows Git Bash 特定路径
if [ -d "/c/Users/{{ .chezmoi.username }}/.local/bin" ]; then
    export PATH="/c/Users/{{ .chezmoi.username }}/.local/bin:$PATH"
fi
if [ -d "/c/Users/{{ .chezmoi.username }}/AppData/Roaming/uv/python" ]; then
    export PATH="/c/Users/{{ .chezmoi.username }}/AppData/Roaming/uv/python/cpython-3.10.16-windows-x86_64-none:$PATH"
fi
{{ end }}

# ============================================
# fnm (Fast Node Manager) - Node.js 版本管理
# ============================================
# 参考: https://github.com/Schniz/fnm
# fnm 会自动处理 Node 版本管理和 .node-version/.nvmrc 文件的自动切换
if [ -d "{{ .chezmoi.homeDir }}/.local/share/fnm" ]; then
    export PATH="{{ .chezmoi.homeDir }}/.local/share/fnm:$PATH"
    # 初始化 fnm（登录 shell 需要）
    # 明确指定 shell 类型，避免在某些环境下无法自动检测
    if command -v fnm >/dev/null 2>&1; then
        eval "$(fnm env --shell=zsh --use-on-cd)"
        # 如果存在 .node-version 文件，自动激活对应版本
        if [ -f "$HOME/.node-version" ]; then
            NODE_VERSION=$(cat "$HOME/.node-version" 2>/dev/null | tr -d '\n\r' | sed 's/^v//')
            if [ -n "$NODE_VERSION" ]; then
                fnm use "$NODE_VERSION" 2>/dev/null || true
            fi
        fi
    fi
elif [ -d "{{ .chezmoi.homeDir }}/.fnm" ]; then
    export PATH="{{ .chezmoi.homeDir }}/.fnm:$PATH"
    # 明确指定 shell 类型，避免在某些环境下无法自动检测
    if command -v fnm >/dev/null 2>&1; then
        eval "$(fnm env --shell=zsh --use-on-cd)"
        # 如果存在 .node-version 文件，自动激活对应版本
        if [ -f "$HOME/.node-version" ]; then
            NODE_VERSION=$(cat "$HOME/.node-version" 2>/dev/null | tr -d '\n\r' | sed 's/^v//')
            if [ -n "$NODE_VERSION" ]; then
                fnm use "$NODE_VERSION" 2>/dev/null || true
            fi
        fi
    fi
fi

# ============================================
# uv (Python 包管理器)
# ============================================
# 参考: https://github.com/astral-sh/uv
# 确保 uv 在 PATH 中（通常安装在 ~/.cargo/bin 或 ~/.local/bin）
if [ -d "{{ .chezmoi.homeDir }}/.cargo/bin" ] && ! echo "$PATH" | grep -q "{{ .chezmoi.homeDir }}/.cargo/bin"; then
    export PATH="{{ .chezmoi.homeDir }}/.cargo/bin:$PATH"
fi

# ============================================
# Pyenv (Python 版本管理)
# ============================================
# 参考: https://github.com/pyenv/pyenv
if command -v pyenv >/dev/null 2>&1; then
    export PYENV_ROOT="{{ .chezmoi.homeDir }}/.pyenv"
    export PATH="$PYENV_ROOT/bin:$PATH"
    # 登录 shell 需要 init --path
    eval "$(pyenv init --path)"
    eval "$(pyenv init -)"
    export PATH="$PYENV_ROOT/shims:$PATH"
fi

# ============================================
# 其他工具初始化（按需取消注释）
# ============================================

# Direnv - 自动加载 .envrc 文件
# if command -v direnv >/dev/null 2>&1; then
#     eval "$(direnv hook zsh)"
# fi

# SDKMAN - Java 开发工具管理
# export SDKMAN_DIR="{{ .chezmoi.homeDir }}/.sdkman"
# [[ -s "$SDKMAN_DIR/bin/sdkman-init.sh" ]] && source "$SDKMAN_DIR/bin/sdkman-init.sh"

# Go 环境
# export GOPATH="{{ .chezmoi.homeDir }}/go"
# export PATH="{{ .chezmoi.homeDir }}/go/bin:$PATH"

# Rust 环境（通常已通过 ~/.cargo/bin 配置）
# export CARGO_HOME="{{ .chezmoi.homeDir }}/.cargo"
# export RUSTUP_HOME="{{ .chezmoi.homeDir }}/.rustup"

# ============================================
# 字符编码设置（确保中文正确显示）
# ============================================
{{ if eq .chezmoi.os "windows" }}
# Windows Git Bash 环境
export LANG=zh_CN.UTF-8
export LC_ALL=zh_CN.UTF-8
export LC_CTYPE=zh_CN.UTF-8
export TERM=xterm-256color
{{ end }}

# ============================================
# 加载 .zshrc（交互式 shell 配置）
# ============================================
# 让 login shell 也读取 .zshrc（防止漏掉极少数只在 interactive 才需要的变量）
[ -f ~/.zshrc ] && source ~/.zshrc

{{- end -}}

