# SSH 配置（由 chezmoi 管理）
# GitHub 走 443 端口（ssh.github.com:443），避免代理或防火墙对 22 端口的限制；经代理时使用 ProxyCommand
#
# 按 OS/WSL 差异简述：
# - Windows 本机：ProxyCommand 使用 connect.exe（随 Git for Windows），proxy_host 默认 127.0.0.1
# - macOS：ProxyCommand 使用 connect 绝对路径（Homebrew），proxy_host 默认 127.0.0.1
# - Linux 原生：proxy_host 默认 127.0.0.1，需安装 connect/connect-proxy
# - WSL（Linux 子类型）：127.0.0.1 指向 WSL 自身，代理在宿主机；data.proxy_host 在 apply 时由 chezmoi.toml 取 /etc/resolv.conf 的 nameserver，或 apply 前 export PROXY_HOST 即可

# --- GitHub：ssh.github.com:443，经代理时使用 ProxyCommand ---
# Windows：connect.exe -S 为 SOCKS 代理，127.0.0.1 即本机
# macOS：ProxyCommand 必须写 connect 的绝对路径；darwin 下按架构选择：arm64（Apple Silicon）→ /opt/homebrew/bin/connect，amd64（Intel）→ /usr/local/bin/connect；若设置 CHEZMOI_MACOS_CONNECT_PATH 或 data.macos_connect_path 则优先使用；-S = SOCKS，-H = HTTP
# Linux/WSL：WSL 下 127.0.0.1 指向 WSL 自身，代理在宿主机，需设置 proxy_host 为宿主机 IP（/etc/resolv.conf 的 nameserver）
#            或在应用前 export PROXY_HOST=$(cat /etc/resolv.conf | grep nameserver | awk '{print $2}')；需安装 connect-proxy（apt: connect-proxy）
#            若 WSL 将 ~/.ssh 软链接到宿主机（/mnt/c/Users/.../.ssh），则本模板管理的是 WSL 内独立 ~/.ssh，不会覆盖软链接目标；此时需在 WSL 内单独维护 config 或使用本仓库 apply 的独立 ~/.ssh，并设置 ProxyCommand 为宿主机 IP。
Host github.com
    HostName ssh.github.com
    Port 443
    User git
    IdentityFile {{ .identity_file | default "~/.ssh/id_rsa" }}
{{- if eq .chezmoi.os "windows" }}
{{- $win_connect := or (.windows_git_connect_path) (trim (output "cmd" "/c" "if exist \"C:\\Program Files\\Git\\mingw64\\bin\\connect.exe\" (echo C:/Program Files/Git/mingw64/bin/connect.exe) else (if exist \"D:\\Program Files\\Git\\mingw64\\bin\\connect.exe\" (echo D:/Program Files/Git/mingw64/bin/connect.exe) else (echo C:/Program Files/Git/mingw64/bin/connect.exe))")) }}
    ProxyCommand "{{ $win_connect }}" -S {{ .proxy_host | default "127.0.0.1" }}:{{ .proxy_port | default "7890" }} %h %p
{{- else if eq .chezmoi.os "darwin" }}
    ProxyCommand "{{ $macos_connect := or (env "CHEZMOI_MACOS_CONNECT_PATH") (index . "macos_connect_path") }}{{ if $macos_connect }}{{ $macos_connect }}{{ else if eq .chezmoi.arch "arm64" }}/opt/homebrew/bin/connect{{ else if eq .chezmoi.arch "amd64" }}/usr/local/bin/connect{{ else }}/usr/local/bin/connect{{ end }}" {{ index . "macos_proxy_connect_opt" | default "-S" }} {{ index . "proxy_host" | default "127.0.0.1" }}:{{ index . "proxy_port" | default "7890" }} %h %p
{{- else if eq .chezmoi.os "linux" }}
{{- $ph := or (env "PROXY_HOST") .proxy_host "127.0.0.1" }}
{{- $pp := or (env "PROXY_PORT") .proxy_port "7890" }}
    ProxyCommand connect -S {{ $ph }}:{{ $pp }} %h %p
{{- end }}

# --- Alchemy / Moicen VNC（ssh to alchemy/moicen through VNC）---
Host alchemy-vnc
    HostName alchemy-studio.cn
    User leonli
    LocalForward 5901 localhost:5901

Host moicen-vnc
    HostName moicen.com
    User leonli
    LocalForward 5904 localhost:5901

# 其他 Host（如内网 Git 服务器）请在本机或 lazyssh 中单独添加
# --- 其他 Host 默认 ---
Host *
    ForwardAgent yes
    SetEnv TERM=xterm-256color
