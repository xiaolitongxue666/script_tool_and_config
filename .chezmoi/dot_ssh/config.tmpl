# SSH 配置（由 chezmoi 管理）
# GitHub 走 443 端口（ssh.github.com:443），避免代理或防火墙对 22 端口的限制；经代理时使用 ProxyCommand
#
# 按 OS/WSL 差异简述：
# - Windows 本机：ProxyCommand 使用 connect.exe（随 Git for Windows），proxy_host 默认 127.0.0.1
# - macOS：ProxyCommand 使用 connect 绝对路径（Homebrew），proxy_host 默认 127.0.0.1
# - Linux 原生：proxy_host 默认 127.0.0.1，需安装 connect/connect-proxy
# - WSL（Linux 子类型）：127.0.0.1 指向 WSL 自身，代理在宿主机；data.proxy_host 在 apply 时由 chezmoi.toml 取 /etc/resolv.conf 的 nameserver，或 apply 前 export PROXY_HOST 即可

# --- GitHub：ssh.github.com:443；仅当 ssh_use_proxy=true 时使用 ProxyCommand（需 connect/connect.exe），否则直连 ---
# Windows：不设代理时无需 connect.exe；设代理时需 connect.exe（随 Git for Windows），路径见 windows_git_connect_path
# macOS/Linux：设代理时需 connect/connect-proxy
Host github.com
    HostName ssh.github.com
    Port 443
    User git
    IdentityFile {{ .identity_file | default "~/.ssh/id_rsa" }}
{{- if index . "ssh_use_proxy" }}
{{- if eq .chezmoi.os "windows" }}
{{- $win_detect := trim (output "cmd" "/c" "if exist \"D:\\Program Files\\Git\\mingw64\\bin\\connect.exe\" (echo D:/Program Files/Git/mingw64/bin/connect.exe) else (if exist \"C:\\Program Files\\Git\\mingw64\\bin\\connect.exe\" (echo C:/Program Files/Git/mingw64/bin/connect.exe) else (echo.))") }}
{{- $win_connect := or $win_detect (.windows_git_connect_path) "C:/Program Files/Git/mingw64/bin/connect.exe" }}
    ProxyCommand "{{ $win_connect }}" -S {{ .proxy_host | default "127.0.0.1" }}:{{ .proxy_port | default "7890" }} %h %p
{{- else if eq .chezmoi.os "darwin" }}
    ProxyCommand "{{ $macos_connect := or (env "CHEZMOI_MACOS_CONNECT_PATH") (index . "macos_connect_path") }}{{ if $macos_connect }}{{ $macos_connect }}{{ else if eq .chezmoi.arch "arm64" }}/opt/homebrew/bin/connect{{ else if eq .chezmoi.arch "amd64" }}/usr/local/bin/connect{{ else }}/usr/local/bin/connect{{ end }}" {{ index . "macos_proxy_connect_opt" | default "-S" }} {{ index . "proxy_host" | default "127.0.0.1" }}:{{ index . "proxy_port" | default "7890" }} %h %p
{{- else if eq .chezmoi.os "linux" }}
{{- $ph := or (env "PROXY_HOST") .proxy_host "127.0.0.1" }}
{{- $pp := or (env "PROXY_PORT") .proxy_port "7890" }}
    ProxyCommand connect -S {{ $ph }}:{{ $pp }} %h %p
{{- end }}
{{- end }}

# --- Alchemy / Moicen VNC（ssh to alchemy/moicen through VNC）---
Host alchemy-vnc
    HostName alchemy-studio.cn
    User leonli
    LocalForward 5901 localhost:5901

Host moicen-vnc
    HostName moicen.com
    User leonli
    LocalForward 5904 localhost:5901

# 其他 Host（如内网 Git 服务器）请在本机或 lazyssh 中单独添加
# --- 其他 Host 默认 ---
Host *
    ForwardAgent yes
    SetEnv TERM=xterm-256color
