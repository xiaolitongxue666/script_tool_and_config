{{- if or (eq .chezmoi.os "linux") (eq .chezmoi.os "darwin") (eq .chezmoi.os "windows") -}}
#!/bin/bash

# ============================================
# Zsh 和 Oh My Zsh 安装脚本（chezmoi run_once_）
# 支持 Linux/macOS/Windows (MSYS2)
# ============================================

# 获取 common_install.sh 路径
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/../.." && pwd 2>/dev/null || echo "$HOME")"
COMMON_INSTALL="${PROJECT_ROOT}/scripts/chezmoi/common_install.sh"

if [ ! -f "$COMMON_INSTALL" ]; then
    COMMON_INSTALL="$HOME/.local/share/chezmoi/scripts/chezmoi/common_install.sh"
fi

# 加载通用函数库
if [ -f "$COMMON_INSTALL" ]; then
    source "$COMMON_INSTALL"
else
    echo "[WARNING] 未找到 common_install.sh，使用基本函数"
    function setup_proxy() { :; }
    function detect_os_and_package_manager() {
        OS="$(uname -s)"
        if [[ "$OS" == "Darwin" ]]; then
            PLATFORM="macos"
            PACKAGE_MANAGER="brew"
        elif [[ "$OS" == "Linux" ]]; then
            PLATFORM="linux"
            if command -v pacman &> /dev/null; then
                PACKAGE_MANAGER="pacman"
            elif command -v apt-get &> /dev/null; then
                PACKAGE_MANAGER="apt"
            fi
        elif [[ "$OS" =~ ^(MINGW|MSYS|CYGWIN) ]]; then
            PLATFORM="windows"
            if command -v pacman.exe &> /dev/null; then
                PACKAGE_MANAGER="pacman"
            fi
        fi
    }
    function install_package() {
        local pkg="$1"
        if [[ "$PACKAGE_MANAGER" == "brew" ]]; then
            brew install "$pkg"
        elif [[ "$PACKAGE_MANAGER" == "pacman" ]]; then
            if [[ "$PLATFORM" == "windows" ]]; then
                pacman.exe -S --noconfirm "$pkg"
            else
                sudo pacman -S --noconfirm "$pkg"
            fi
        elif [[ "$PACKAGE_MANAGER" == "apt" ]]; then
            sudo apt-get update && sudo apt-get install -y "$pkg"
        fi
    }
fi

# 设置代理
setup_proxy "${PROXY:-{{ .proxy }}}"

# 检测操作系统和包管理器
detect_os_and_package_manager || exit 1

# 检查 Zsh 是否已安装
if command -v zsh &> /dev/null; then
    echo "[INFO] Zsh 已安装: $(zsh --version)"
else
    echo "[INFO] 开始安装 Zsh..."

    case "$PLATFORM" in
        macos)
            if [[ "$PACKAGE_MANAGER" == "brew" ]]; then
                install_package "zsh"
            else
                echo "[INFO] macOS 通常已预装 Zsh"
            fi
            ;;
        linux)
            install_package "zsh"
            ;;
        windows)
            if [[ "$PACKAGE_MANAGER" == "pacman" ]]; then
                echo "[INFO] 通过 MSYS2 安装 Zsh..."
                install_package "zsh"
            else
                echo "[WARNING] Windows 上需要 MSYS2 来安装 Zsh"
                exit 1
            fi
            ;;
        *)
            echo "[ERROR] 不支持的操作系统"
            exit 1
            ;;
    esac
fi

# 安装 Oh My Zsh（仅 Linux/macOS，Windows 可选）
if [[ "$PLATFORM" != "windows" ]]; then
    if [ ! -d "$HOME/.oh-my-zsh" ]; then
        echo "[INFO] 安装 Oh My Zsh..."
        export RUNZSH=no
        export KEEP_ZSHRC=yes
        export CHSH=no

        # 使用 download_with_progress 函数（如果可用），否则使用 curl
        local install_script="/tmp/install_oh_my_zsh.sh"
        if type download_with_progress &>/dev/null; then
            if download_with_progress "https://raw.githubusercontent.com/ohmyzsh/ohmyzsh/master/tools/install.sh" "${install_script}" 60 3; then
                chmod +x "${install_script}"
                bash "${install_script}"
                rm -f "${install_script}"
            else
                echo "[WARNING] 下载 Oh My Zsh 安装脚本失败，尝试直接安装..."
                sh -c "$(curl -fsSL https://raw.githubusercontent.com/ohmyzsh/ohmyzsh/master/tools/install.sh)" || {
                    echo "[WARNING] Oh My Zsh 安装失败，但继续..."
                }
            fi
        else
            # 回退到使用 curl 直接安装
            sh -c "$(curl -fsSL https://raw.githubusercontent.com/ohmyzsh/ohmyzsh/master/tools/install.sh)" || {
                echo "[WARNING] Oh My Zsh 安装失败，但继续..."
            }
        fi
    else
        echo "[INFO] Oh My Zsh 已安装"
    fi

    # 安装 Oh My Zsh 插件（Fish-like 体验）
    if [ -d "$HOME/.oh-my-zsh" ]; then
        echo "[INFO] 安装 Oh My Zsh 插件..."
        ZSH_CUSTOM="${ZSH_CUSTOM:-$HOME/.oh-my-zsh/custom}/plugins"
        mkdir -p "$ZSH_CUSTOM"

        # 插件列表
        declare -A PLUGINS=(
            ["zsh-autosuggestions"]="https://github.com/zsh-users/zsh-autosuggestions"
            ["zsh-history-substring-search"]="https://github.com/zsh-users/zsh-history-substring-search"
            ["zsh-syntax-highlighting"]="https://github.com/zsh-users/zsh-syntax-highlighting"
        )

        for plugin_name in "${!PLUGINS[@]}"; do
            plugin_url="${PLUGINS[$plugin_name]}"
            plugin_path="$ZSH_CUSTOM/$plugin_name"

            if [ -d "$plugin_path" ]; then
                echo "[INFO] 插件 $plugin_name 已安装，跳过"
            else
                echo "[INFO] 安装插件 $plugin_name..."
                if git clone "$plugin_url" "$plugin_path" 2>/dev/null; then
                    echo "[INFO] 插件 $plugin_name 安装成功"
                else
                    echo "[WARNING] 插件 $plugin_name 安装失败，但继续..."
                fi
            fi
        done
    fi
else
    echo "[INFO] Windows 上跳过 Oh My Zsh 安装（可选）"
fi

echo "[SUCCESS] Zsh 和 Oh My Zsh 安装完成"
{{- end -}}

