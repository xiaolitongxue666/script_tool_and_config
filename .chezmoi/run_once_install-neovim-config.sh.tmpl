{{- if or (eq .chezmoi.os "linux") (eq .chezmoi.os "darwin") (eq .chezmoi.os "windows") -}}
#!/bin/bash

# ============================================
# Neovim 配置安装脚本（通过 Git Submodule 管理）
# ============================================
# 此脚本负责：
# 1. 初始化 Git Submodule（如果未初始化）
# 2. 运行 Neovim 配置的安装脚本
# 3. 确保前置依赖（uv, fnm）已安装
# ============================================

set -e

# 获取脚本所在目录
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="${CHEZMOI_PROJECT_ROOT:-$(cd "${SCRIPT_DIR}/../.." && pwd)}"
NVIM_SUBMODULE_DIR="${PROJECT_ROOT}/dotfiles/nvim"
NVIM_INSTALL_SCRIPT="${NVIM_SUBMODULE_DIR}/install.sh"
NVIM_CONFIG_DIR="{{ .chezmoi.homeDir }}/.config/nvim"

# 日志函数
log_info() {
    echo "[INFO] $*"
}

log_success() {
    echo "[SUCCESS] $*"
}

log_warning() {
    echo "[WARNING] $*"
}

log_error() {
    echo "[ERROR] $*" >&2
}

# ============================================
# 检查前置依赖
# ============================================
check_prerequisites() {
    log_info "检查前置依赖..."

    # 检查 uv
    if ! command -v uv >/dev/null 2>&1; then
        log_warning "uv 未安装，Neovim Python 环境可能无法正常工作"
        log_info "请先运行 run_once_install-version-managers.sh.tmpl 安装 uv"
    else
        log_success "uv 已安装: $(uv --version | head -n 1)"
    fi

    # 检查 fnm
    if ! command -v fnm >/dev/null 2>&1; then
        log_warning "fnm 未安装，Neovim Node.js 环境可能无法正常工作"
        log_info "请先运行 run_once_install-version-managers.sh.tmpl 安装 fnm"
    else
        log_success "fnm 已安装: $(fnm --version)"
    fi

    # 检查 Neovim
    if ! command -v nvim >/dev/null 2>&1; then
        log_warning "Neovim 未安装，请先安装 Neovim"
        {{ if eq .chezmoi.os "linux" }}
        log_info "Linux: sudo pacman -S neovim 或 sudo apt-get install neovim"
        {{ else if eq .chezmoi.os "darwin" }}
        log_info "macOS: brew install neovim"
        {{ else if eq .chezmoi.os "windows" }}
        log_info "Windows: 从 https://github.com/neovim/neovim/releases 下载安装"
        {{ end }}
    else
        log_success "Neovim 已安装: $(nvim --version | head -n 1)"
    fi
}

# ============================================
# 初始化 Git Submodule
# ============================================
# 先尝试 SSH；失败则清除半成品、改为 HTTPS 并用当前代理重试（不执行 git submodule sync）
init_submodule() {
    log_info "检查 Git Submodule..."

    if [ ! -f "${NVIM_SUBMODULE_DIR}/init.lua" ] && [ ! -d "${NVIM_SUBMODULE_DIR}/lua" ]; then
        log_info "Neovim Submodule 未初始化，开始初始化..."
        cd "${PROJECT_ROOT}" || exit 1

        PROXY_URL="${PROXY:-{{ env "http_proxy" | default "http://127.0.0.1:7890" }}}"
        export http_proxy="$PROXY_URL"
        export https_proxy="$PROXY_URL"
        export HTTP_PROXY="$PROXY_URL"
        export HTTPS_PROXY="$PROXY_URL"
        log_info "代理环境: $PROXY_URL（SSH 克隆不走代理；仅 HTTPS 回退时使用）"

        submodule_ok=false
        if git submodule update --init --recursive dotfiles/nvim 2>&1; then
            log_success "Neovim Submodule 初始化成功（SSH）"
            submodule_ok=true
        fi

        if [ "$submodule_ok" = false ]; then
            log_warning "SSH 克隆失败，尝试 HTTPS + 代理回退..."
            rm -rf "${NVIM_SUBMODULE_DIR}" ".git/modules/dotfiles" 2>/dev/null || true
            git config submodule.dotfiles/nvim.url "https://github.com/xiaolitongxue666/nvim.git"
            if git -c "http.https://github.com.proxy=$PROXY_URL" -c "https.https://github.com.proxy=$PROXY_URL" submodule update --init --recursive dotfiles/nvim 2>&1; then
                log_success "Neovim Submodule 初始化成功（HTTPS）"
                submodule_ok=true
            fi
        fi

        if [ "$submodule_ok" = false ]; then
            log_error "Neovim Submodule 初始化失败（SSH 与 HTTPS 回退均失败）"
            exit 1
        fi
    else
        log_success "Neovim Submodule 已初始化"
    fi
}

# ============================================
# 运行 Neovim 安装脚本
# ============================================
run_nvim_install() {
    if [ ! -f "${NVIM_INSTALL_SCRIPT}" ]; then
        log_error "Neovim 安装脚本不存在: ${NVIM_INSTALL_SCRIPT}"
        exit 1
    fi

    log_info "运行 Neovim 配置安装脚本..."
    chmod +x "${NVIM_INSTALL_SCRIPT}"

    # 设置代理环境变量（使用 PROXY 或 http_proxy）
    PROXY_URL="${PROXY:-{{ env "http_proxy" | default "http://127.0.0.1:7890" }}}"
    export http_proxy="$PROXY_URL"
    export https_proxy="$PROXY_URL"
    export HTTP_PROXY="$PROXY_URL"
    export HTTPS_PROXY="$PROXY_URL"

    # 运行安装脚本
    if bash "${NVIM_INSTALL_SCRIPT}" 2>&1; then
        log_success "Neovim 配置安装成功"
    else
        log_error "Neovim 配置安装失败"
        exit 1
    fi
}

# ============================================
# 验证安装
# ============================================
verify_installation() {
    log_info "验证 Neovim 配置安装..."

    if [ -d "${NVIM_CONFIG_DIR}" ] && [ -f "${NVIM_CONFIG_DIR}/init.lua" ]; then
        log_success "Neovim 配置目录已创建: ${NVIM_CONFIG_DIR}"
    else
        log_warning "Neovim 配置目录不存在或配置不完整: ${NVIM_CONFIG_DIR}"
    fi
}

# ============================================
# 主函数
# ============================================
main() {
    log_info ""
    log_info "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
    log_info "开始安装 Neovim 配置"
    log_info "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"

    check_prerequisites
    init_submodule
    run_nvim_install
    verify_installation

    log_info ""
    log_success "Neovim 配置安装完成！"
    log_info ""
    log_info "使用说明："
    log_info "  1. 运行 nvim 启动 Neovim"
    log_info "  2. 首次启动时会自动安装插件（可能需要一些时间）"
    log_info "  3. 更新配置: cd ${NVIM_SUBMODULE_DIR} && git pull && ./install.sh"
    log_info ""
}

# 执行主函数
main
{{- end -}}

