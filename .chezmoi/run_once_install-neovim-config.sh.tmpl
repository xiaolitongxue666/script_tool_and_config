{{- if or (eq .chezmoi.os "linux") (eq .chezmoi.os "darwin") (eq .chezmoi.os "windows") -}}
#!/bin/bash

# ============================================
# Neovim 配置安装脚本（克隆 nvim 仓库到系统目录）
# ============================================
# 依赖执行顺序：run_once_00-install-version-managers、install-neovim 先于本脚本
# 本脚本负责：
# 1. 校验前置（uv、fnm、nvim）已安装并可用
# 2. 将 nvim 仓库克隆到 ~/.config/nvim（若已存在则 git pull）
# 3. 执行 ~/.config/nvim/install.sh（注入 PROJECT_ROOT/COMMON_LIB）
# 4. 引导 lazy.nvim 与插件
# ============================================

set -e

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="${CHEZMOI_PROJECT_ROOT:-$(cd "${SCRIPT_DIR}/../.." && pwd)}"
COMMON_INSTALL="${PROJECT_ROOT}/scripts/chezmoi/common_install.sh"
COMMON_LIB="${PROJECT_ROOT}/scripts/common.sh"
NVIM_CONFIG_DIR="{{ .chezmoi.homeDir }}/.config/nvim"
NVIM_REPO_SSH="git@github.com:xiaolitongxue666/nvim.git"
NVIM_REPO_HTTPS="https://github.com/xiaolitongxue666/nvim.git"

if [[ -f "${COMMON_INSTALL}" ]]; then
    # shellcheck source=scripts/chezmoi/common_install.sh
    source "${COMMON_INSTALL}"
fi

log_info() { echo "[INFO] $*"; }
log_success() { echo "[SUCCESS] $*"; }
log_warning() { echo "[WARNING] $*"; }
log_error() { echo "[ERROR] $*" >&2; }

# ============================================
# 检查前置依赖（仅日志）
# ============================================
check_prerequisites() {
    log_info "检查前置依赖..."
    command -v uv >/dev/null 2>&1 && log_success "uv 已安装: $(uv --version | head -n 1)" || log_warning "uv 未安装"
    command -v fnm >/dev/null 2>&1 && log_success "fnm 已安装: $(fnm --version)" || log_warning "fnm 未安装"
    command -v nvim >/dev/null 2>&1 && log_success "Neovim 已安装: $(nvim --version | head -n 1)" || log_warning "Neovim 未安装"
}

# ============================================
# 校验前置：uv、fnm、nvim 必须已安装并可用
# ============================================
verify_nvim_prerequisites() {
    log_info "校验前置（uv、fnm、nvim）..."
    local missing=""
    command -v uv >/dev/null 2>&1 || missing="${missing} uv"
    command -v fnm >/dev/null 2>&1 || missing="${missing} fnm"
    command -v nvim >/dev/null 2>&1 || missing="${missing} nvim"
    if [[ -n "${missing}" ]]; then
        log_error "缺少前置:${missing}。请先完成 00-install-version-managers 与 install-neovim 后再次执行 ./install.sh"
        log_info "run_once 顺序：00-install-version-managers → install-neovim → install-neovim-config"
        exit 1
    fi
    uv --version &>/dev/null || { log_error "uv 不可用"; exit 1; }
    fnm --version &>/dev/null || { log_error "fnm 不可用"; exit 1; }
    nvim --version &>/dev/null || { log_error "nvim 不可用"; exit 1; }
    if [[ -f "${COMMON_INSTALL}" ]] && type is_nvim_version_ge_0_11 &>/dev/null; then
        is_nvim_version_ge_0_11 || {
            log_error "Neovim 版本低于 0.11.0，本配置需要 0.11.0+。请先执行 run_once_install-neovim 完成安装/升级"
            exit 1
        }
    fi
    log_success "前置校验通过"
}

# ============================================
# 克隆或更新 nvim 仓库到 ~/.config/nvim
# ============================================
clone_or_update_nvim() {
    log_info "检查 Neovim 配置目录: ${NVIM_CONFIG_DIR}"

    if [[ -d "${NVIM_CONFIG_DIR}/.git" ]]; then
        log_info "已有 git 仓库，执行 git pull..."
        cd "${NVIM_CONFIG_DIR}" || exit 1
        PROXY_URL="${PROXY:-{{ env "http_proxy" | default .proxy | default "http://127.0.0.1:7890" }}}"
        export http_proxy="$PROXY_URL" https_proxy="$PROXY_URL" HTTP_PROXY="$PROXY_URL" HTTPS_PROXY="$PROXY_URL"
        if git pull --rebase 2>&1; then
            log_success "Neovim 配置已更新"
        else
            log_warning "git pull 失败，继续使用当前配置"
        fi
        cd - >/dev/null || true
        return 0
    fi

    if [[ -d "${NVIM_CONFIG_DIR}" ]] && [[ -n "$(ls -A "${NVIM_CONFIG_DIR}" 2>/dev/null)" ]]; then
        log_warning "目录已存在且非 git 仓库，备份后克隆"
        local backup="${NVIM_CONFIG_DIR}.backup.$(date +%Y%m%d_%H%M%S)"
        mv "${NVIM_CONFIG_DIR}" "${backup}" 2>/dev/null || { log_error "无法备份 ${NVIM_CONFIG_DIR}"; exit 1; }
        log_info "已备份到 ${backup}"
    fi

    mkdir -p "$(dirname "${NVIM_CONFIG_DIR}")"
    PROXY_URL="${PROXY:-{{ env "http_proxy" | default .proxy | default "http://127.0.0.1:7890" }}}"
    export http_proxy="$PROXY_URL" https_proxy="$PROXY_URL" HTTP_PROXY="$PROXY_URL" HTTPS_PROXY="$PROXY_URL"
    log_info "代理: ${PROXY_URL}"

    log_info "克隆 nvim 仓库到 ${NVIM_CONFIG_DIR}..."
    if git clone "${NVIM_REPO_SSH}" "${NVIM_CONFIG_DIR}" 2>&1; then
        log_success "克隆成功（SSH）"
        return 0
    fi

    log_warning "SSH 克隆失败，尝试 HTTPS..."
    rm -rf "${NVIM_CONFIG_DIR}" 2>/dev/null || true
    if git -c "http.https://github.com.proxy=$PROXY_URL" -c "https.https://github.com.proxy=$PROXY_URL" clone "${NVIM_REPO_HTTPS}" "${NVIM_CONFIG_DIR}" 2>&1; then
        log_success "克隆成功（HTTPS）"
        return 0
    fi

    log_error "克隆 nvim 仓库失败（SSH 与 HTTPS 均失败）"
    exit 1
}

# ============================================
# 运行 ~/.config/nvim/install.sh（注入 PROJECT_ROOT / COMMON_LIB）
# ============================================
run_nvim_install() {
    local install_script="${NVIM_CONFIG_DIR}/install.sh"
    if [[ ! -f "${install_script}" ]]; then
        log_error "Neovim 安装脚本不存在: ${install_script}"
        exit 1
    fi

    log_info "运行 Neovim 配置安装脚本（注入 PROJECT_ROOT/COMMON_LIB）..."
    chmod +x "${install_script}"

    PROXY_URL="${PROXY:-{{ env "http_proxy" | default .proxy | default "http://127.0.0.1:7890" }}}"
    export PROXY_URL http_proxy="$PROXY_URL" https_proxy="$PROXY_URL" HTTP_PROXY="$PROXY_URL" HTTPS_PROXY="$PROXY_URL"
    export PROJECT_ROOT COMMON_LIB

    if bash "${install_script}" 2>&1; then
        log_success "Neovim 配置安装成功"
    else
        log_error "Neovim 配置安装失败"
        exit 1
    fi
}

# ============================================
# 引导 lazy.nvim 与插件
# ============================================
bootstrap_lazy_plugins() {
    if [[ "${NVIM_SKIP_BOOTSTRAP:-0}" = "1" ]]; then
        log_info "跳过 Lazy 插件引导（NVIM_SKIP_BOOTSTRAP=1）"
        return 0
    fi
    if ! command -v nvim >/dev/null 2>&1; then
        log_warning "未找到 nvim，跳过插件引导"
        return 0
    fi
    if [[ ! -f "${NVIM_CONFIG_DIR}/init.lua" ]]; then
        log_warning "Neovim 配置目录不完整，跳过插件引导"
        return 0
    fi
    if [[ -n "${PROXY_URL:-}" ]]; then
        git config --global http.https://github.com.proxy "${PROXY_URL}" 2>/dev/null || true
        git config --global https.https://github.com.proxy "${PROXY_URL}" 2>/dev/null || true
    fi
    LAZY_SYNC_TIMEOUT="${NVIM_LAZY_SYNC_TIMEOUT:-600}"
    log_info "引导 lazy.nvim 与插件（headless，最长等待 ${LAZY_SYNC_TIMEOUT}s）..."
    if timeout "${LAZY_SYNC_TIMEOUT}" nvim --headless "+Lazy! sync" +qa 2>&1; then
        log_success "lazy.nvim 与插件引导完成"
    else
        local ec=$?
        [[ "$ec" = 124 ]] && log_warning "lazy.nvim 引导超时，首次启动 nvim 时会继续安装" || log_warning "引导失败或部分未安装，首次启动时会继续"
    fi
}

verify_installation() {
    log_info "验证 Neovim 配置..."
    if [[ -d "${NVIM_CONFIG_DIR}" ]] && [[ -f "${NVIM_CONFIG_DIR}/init.lua" ]]; then
        log_success "Neovim 配置目录就绪: ${NVIM_CONFIG_DIR}"
    else
        log_warning "Neovim 配置目录不存在或配置不完整: ${NVIM_CONFIG_DIR}"
    fi
}

main() {
    log_info ""
    log_info "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
    log_info "开始安装 Neovim 配置（克隆到系统目录）"
    log_info "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"

    check_prerequisites
    verify_nvim_prerequisites

    PROXY_URL="${PROXY:-{{ env "http_proxy" | default .proxy | default "http://127.0.0.1:7890" }}}"
    export PROXY_URL http_proxy="$PROXY_URL" https_proxy="$PROXY_URL" HTTP_PROXY="$PROXY_URL" HTTPS_PROXY="$PROXY_URL"
    log_info "代理: ${PROXY_URL}"

    clone_or_update_nvim
    run_nvim_install
    bootstrap_lazy_plugins
    verify_installation

    log_info ""
    log_success "Neovim 配置安装完成！"
    log_info ""
    log_info "使用说明："
    log_info "  1. 运行 nvim 启动 Neovim"
    log_info "  2. 插件已在一键安装时引导（若跳过则首次启动时会自动安装）"
    log_info "  3. 更新配置: cd ${NVIM_CONFIG_DIR} && git pull && ./install.sh"
    log_info ""
}

main
{{- end -}}
