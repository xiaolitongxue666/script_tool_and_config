# Git Bash é…ç½®æ–‡ä»¶
# ä»…é€‚ç”¨äº Windows Git Bash ç¯å¢ƒ
# å‚è€ƒ: https://git-scm.com/docs/git-bash

# ============================================
# ç³»ç»Ÿæ£€æµ‹
# ============================================
# ç¡®ä¿ä»…åœ¨ Git Bash ç¯å¢ƒä¸­åŠ è½½æ­¤é…ç½®
if [[ ! "$OSTYPE" =~ ^(msys|mingw|cygwin) ]]; then
    return 0
fi

# ============================================
# PATH é…ç½®ï¼ˆMSYS2 zsh æ”¯æŒï¼‰
# ============================================
# å¦‚æœ MSYS2 å·²å®‰è£…ï¼Œæ·»åŠ å…¶ bin ç›®å½•åˆ° PATH
# è¿™æ ·å¯ä»¥ä½¿ç”¨ MSYS2 ä¸­çš„ zsh å’Œå…¶ä»–å·¥å…·
# æ­¤é…ç½®ç”± zsh å®‰è£…è„šæœ¬è‡ªåŠ¨ç®¡ç†
for msys2_bin in \
    "/c/msys64/usr/bin" \
    "/d/msys64/usr/bin" \
    "/c/Program Files/msys64/usr/bin" \
    "/d/Program Files/msys64/usr/bin" \
    "/c/Program Files (x86)/msys64/usr/bin" \
    "/d/Program Files (x86)/msys64/usr/bin"; do
    if [ -d "$msys2_bin" ] && [ -f "$msys2_bin/zsh.exe" ]; then
        export PATH="$msys2_bin:$PATH"
        break
    fi
done

# ============================================
# å†å²è®°å½•é…ç½®
# ============================================
# è‡ªåŠ¨è¿½åŠ å†å²è®°å½•åˆ°æ–‡ä»¶
PROMPT_COMMAND='history -a'

# å†å²è®°å½•è®¾ç½®
export HISTSIZE=10000
export HISTFILESIZE=20000
export HISTCONTROL=ignoreboth:erasedups
shopt -s histappend

# ============================================
# ä»£ç†é…ç½®ï¼ˆç»Ÿä¸€é…ç½®ï¼Œä½¿ç”¨æ¨¡æ¿å˜é‡ï¼‰
# ============================================
# é»˜è®¤ä»£ç†åœ°å€ï¼ˆä» .chezmoi.toml è¯»å–ï¼Œå¯é€šè¿‡ç¯å¢ƒå˜é‡ PROXY è¦†ç›–ï¼‰
PROXY_URL="${PROXY:-{{ .proxy }}}"

# é»˜è®¤ä»£ç†è®¾ç½®ï¼ˆè‡ªåŠ¨å¯ç”¨ï¼‰
# åŒæ—¶è®¾ç½®å¤§å°å†™ç¯å¢ƒå˜é‡ï¼Œç¡®ä¿ä¸åŒå·¥å…·éƒ½èƒ½è¯†åˆ«
export http_proxy="$PROXY_URL"
export https_proxy="$PROXY_URL"
export HTTP_PROXY="$PROXY_URL"
export HTTPS_PROXY="$PROXY_URL"
export all_proxy="$PROXY_URL"
export ALL_PROXY="$PROXY_URL"

# ä»£ç†æ§åˆ¶åˆ«å
# h_proxy: å¿«é€Ÿå¯ç”¨ä»£ç†ï¼ˆåŒæ—¶è®¾ç½®å¤§å°å†™ç¯å¢ƒå˜é‡ï¼‰
alias h_proxy='export http_proxy='"$PROXY_URL"'; export https_proxy='"$PROXY_URL"'; export HTTP_PROXY='"$PROXY_URL"'; export HTTPS_PROXY='"$PROXY_URL"'; export all_proxy='"$PROXY_URL"'; export ALL_PROXY='"$PROXY_URL"'; echo "ä»£ç†å·²å¯ç”¨: $PROXY_URL"'
# unset_h: å…³é—­ä»£ç†ï¼ˆæ¸…é™¤æ‰€æœ‰ä»£ç†ç¯å¢ƒå˜é‡ï¼‰
alias unset_h='unset http_proxy; unset https_proxy; unset HTTP_PROXY; unset HTTPS_PROXY; unset all_proxy; unset ALL_PROXY; echo "ä»£ç†å·²å…³é—­"'

# curl åŒ…è£…å‡½æ•°ï¼ˆç¡®ä¿ä»£ç†ç”Ÿæ•ˆï¼‰
# Windows Git Bash ä¸­çš„ curl å¯èƒ½ä¸ä¼šè‡ªåŠ¨è¯†åˆ«ç¯å¢ƒå˜é‡ï¼Œéœ€è¦æ˜¾å¼ä½¿ç”¨ --proxy
curl() {
    local proxy_url=""
    # æ£€æŸ¥ä»£ç†ç¯å¢ƒå˜é‡ï¼ˆä¼˜å…ˆä½¿ç”¨å°å†™ï¼Œç„¶åå¤§å†™ï¼‰
    if [ -n "$http_proxy" ]; then
        proxy_url="$http_proxy"
    elif [ -n "$HTTP_PROXY" ]; then
        proxy_url="$HTTP_PROXY"
    elif [ -n "$all_proxy" ]; then
        proxy_url="$all_proxy"
    elif [ -n "$ALL_PROXY" ]; then
        proxy_url="$ALL_PROXY"
    elif [ -n "$PROXY_URL" ]; then
        proxy_url="$PROXY_URL"
    fi

    # å¦‚æœè®¾ç½®äº†ä»£ç†ä¸”æ²¡æœ‰æ˜¾å¼æŒ‡å®š --proxy æˆ– --noproxyï¼Œåˆ™è‡ªåŠ¨æ·»åŠ  --proxy
    if [ -n "$proxy_url" ]; then
        # æ£€æŸ¥å‚æ•°ä¸­æ˜¯å¦å·²æœ‰ --proxy æˆ– --noproxy
        local has_proxy_flag=false
        local has_noproxy_flag=false
        for arg in "$@"; do
            if [[ "$arg" == --proxy* ]] || [[ "$arg" == --proxy=* ]]; then
                has_proxy_flag=true
                break
            fi
            if [[ "$arg" == --noproxy* ]]; then
                has_noproxy_flag=true
                break
            fi
        done

        # å¦‚æœæ²¡æœ‰ä»£ç†æ ‡å¿—ä¸”æ²¡æœ‰ç¦ç”¨ä»£ç†æ ‡å¿—ï¼Œåˆ™æ·»åŠ  --proxy
        if [ "$has_proxy_flag" = false ] && [ "$has_noproxy_flag" = false ]; then
            command curl --proxy "$proxy_url" "$@"
            return $?
        fi
    fi

    # å¦‚æœæ²¡æœ‰ä»£ç†æˆ–å·²æœ‰ä»£ç†æ ‡å¿—ï¼Œç›´æ¥è°ƒç”¨åŸå§‹ curl
    command curl "$@"
}

# ç½‘ç»œæ£€æŸ¥åˆ«åï¼ˆå¯é€‰ï¼Œå·²æ³¨é‡Šï¼‰
# alias check_network='curl -IL https://www.google.com 2>/dev/null | grep -q -E "200 OK|Connection established" && echo "Network is OK" || echo "Network is down"'

# ============================================
# ç¯å¢ƒå˜é‡é…ç½®
# ============================================

# ç¡®ä¿ HOME å˜é‡æ­£ç¡®è®¾ç½®ï¼ˆWindows Git Bash ç¯å¢ƒï¼‰
# åœ¨ Git Bash ä¸­ï¼ŒHOME åº”è¯¥æŒ‡å‘ Windows ç”¨æˆ·ç›®å½•
if [[ "$OSTYPE" =~ ^(msys|mingw|cygwin) ]]; then
    # å¦‚æœ HOME æŒ‡å‘ /home/Administratorï¼Œä¿®æ­£ä¸º Windows å®é™…è·¯å¾„
    if [ "$HOME" == "/home/Administrator" ] || [ -z "$HOME" ]; then
        export HOME="/c/Users/Administrator"
    fi
    # ç¡®ä¿ HOME æŒ‡å‘æ­£ç¡®çš„ Windows ç”¨æˆ·ç›®å½•
    if [ ! -d "$HOME" ]; then
        # å°è¯•ä»ç¯å¢ƒå˜é‡è·å–
        if [ -n "$USERPROFILE" ]; then
            # è½¬æ¢ Windows è·¯å¾„æ ¼å¼ï¼ˆC:\Users\Administrator -> /c/Users/Administratorï¼‰
            WIN_HOME=$(echo "$USERPROFILE" | sed 's|\\|/|g' | sed 's|^\([A-Za-z]\):|/\1|' | tr '[:upper:]' '[:lower:]' | sed 's|^/\([a-z]\)|/\1|')
            if [ -d "$WIN_HOME" ]; then
                export HOME="$WIN_HOME"
            fi
        fi
    fi
fi

# Google Cloud é¡¹ç›®é…ç½®
export GOOGLE_CLOUD_PROJECT="gen-lang-client-0128654003"

# PostgreSQL é…ç½®
# æ³¨æ„ï¼šè·¯å¾„ä¸­åŒ…å«ç©ºæ ¼ï¼Œä½¿ç”¨å¼•å·åŒ…è£¹
export CARGO_ENCODED_RUSTFLAGS="-L /d/Program Files/PostgreSQL/17/lib"
export C_INCLUDE_PATH="/d/Program Files/PostgreSQL/17/include"

# Python ç¯å¢ƒé…ç½®ï¼ˆuvï¼‰
export PATH="/c/Users/Administrator/.local/bin:/c/Users/Administrator/AppData/Roaming/uv/python/cpython-3.10.16-windows-x86_64-none:$PATH"

# btop4win é…ç½®ï¼ˆç³»ç»Ÿç›‘æ§å·¥å…·ï¼‰
# å¦‚æœ btop4win å·²å®‰è£…ï¼Œæ·»åŠ åˆ° PATH
if [ -d "/c/Program Files/btop4win" ]; then
    export PATH="/c/Program Files/btop4win:$PATH"
fi

# å­—ç¬¦ç¼–ç è®¾ç½®
export LANG=zh_CN.UTF-8
export LC_ALL=zh_CN.UTF-8
export LC_CTYPE=zh_CN.UTF-8

# ============================================
# åˆ«åé…ç½®
# ============================================

# æ–‡ä»¶ç®¡ç†å™¨
alias open='explorer'

# Make å‘½ä»¤ï¼ˆä½¿ç”¨ MinGW ç‰ˆæœ¬ï¼‰
alias make='mingw32-make'

# Python åˆ«å
alias python='python3.10'

# Lua åˆ«åï¼ˆå¯é€‰ï¼Œå·²æ³¨é‡Šï¼‰
# alias lua='lua5.1'

# ä½¿ç”¨ bat æ›¿ä»£ catï¼ˆå¦‚æœå·²å®‰è£…ï¼Œå¯é€‰ï¼‰
# alias cat='bat'

# ============================================
# Docker å·¥ä½œåŒºé…ç½®ï¼ˆå¯é€‰ï¼Œå·²æ³¨é‡Šï¼‰
# ============================================
# Windows ä¸Š Docker çš„è·¯å¾„è½¬æ¢å·¥ä½œåŒº
# docker()
# {
#   (export MSYS_NO_PATHCONV=1; "docker.exe" "$@")
# }
# docker-compose()
# {
#   (export MSYS_NO_PATHCONV=1; "docker-compose.exe" "$@")
# }

# ============================================
# Shell å¢å¼ºå·¥å…·
# ============================================

# æ³¨æ„ï¼šinshellisense æŒ‰é”®ç»‘å®šåœ¨ .bashrc ä¸­åŠ è½½
# è¿™æ ·å¯ä»¥ç¡®ä¿åœ¨éç™»å½• shell ä¸­ä¹Ÿèƒ½ä½¿ç”¨

# Oh My Posh ä¸»é¢˜é…ç½®
# æ³¨æ„ï¼šå¿…é¡»åœ¨ exec zsh ä¹‹å‰æ‰§è¡Œï¼Œå› ä¸ºå®ƒä¼šåˆå§‹åŒ–æç¤ºç¬¦
# ä½†ç”±äºæˆ‘ä»¬ä¼šåˆ‡æ¢åˆ° zshï¼Œè¿™ä¸ªé…ç½®å®é™…ä¸Šä¸ä¼šåœ¨ zsh ä¸­ç”Ÿæ•ˆ
# å¦‚æœéœ€è¦åœ¨ zsh ä¸­ä½¿ç”¨ä¸»é¢˜ï¼Œè¯·åœ¨ .zshrc ä¸­é…ç½®
if command -v oh-my-posh &> /dev/null; then
    eval "$(oh-my-posh --init --shell bash --config ~/AppData/Local/Programs/oh-my-posh/themes/montys.omp.json)"
fi

# Starship æç¤ºç¬¦ï¼ˆå¯é€‰ï¼Œå·²æ³¨é‡Šï¼‰
# å¦‚æœä½¿ç”¨ Starshipï¼Œè¯·æ³¨é‡Šæ‰ Oh My Posh é…ç½®
# eval "$(starship init bash)"

# ============================================
# è‡ªåŠ¨å¯åŠ¨ Zshï¼ˆå¦‚æœå¯ç”¨ï¼‰
# ============================================
# å¦‚æœ zsh å·²å®‰è£…ä¸”å¯ç”¨ï¼Œè‡ªåŠ¨å¯åŠ¨ zsh
# è¿™å…è®¸åœ¨ Alacritty ä¸­å¯åŠ¨ Git Bash åè‡ªåŠ¨åˆ‡æ¢åˆ° zsh
# æ³¨æ„ï¼šexec zsh ä¼šæ›¿æ¢å½“å‰ shell è¿›ç¨‹ï¼Œæ‰€ä»¥å¿…é¡»æ”¾åœ¨æ‰€æœ‰é…ç½®çš„æœ€å
# è¿™æ ·å¯ä»¥ç¡®ä¿æ‰€æœ‰ Git Bash é…ç½®éƒ½å·²åŠ è½½ï¼Œç„¶ååˆ‡æ¢åˆ° zsh
# if command -v zsh &> /dev/null && [ -t 1 ]; then
#     # æ£€æŸ¥æ˜¯å¦å·²ç»åœ¨ zsh ä¸­ï¼ˆé¿å…å¾ªç¯ï¼‰
#     if [ -z "$ZSH_VERSION" ]; then
#         # ç¡®å®šæ­£ç¡®çš„ HOME è·¯å¾„
#         CORRECT_HOME=""
#         if [ -n "$USERPROFILE" ]; then
#             # è½¬æ¢ Windows è·¯å¾„æ ¼å¼ï¼ˆC:\Users\Administrator -> /c/Users/Administratorï¼‰
#             CORRECT_HOME=$(echo "$USERPROFILE" | sed 's|\\|/|g' | sed 's|^\([A-Za-z]\):|/\1|' | tr '[:upper:]' '[:lower:]' | sed 's|^/\([a-z]\)|/\1|')
#             # ç¡®ä¿é¦–å­—æ¯å¤§å†™ï¼ˆUsers è€Œä¸æ˜¯ usersï¼‰
#             CORRECT_HOME=$(echo "$CORRECT_HOME" | sed 's|^/\([a-z]\)/\([a-z]*\)|/\1/\u\2|')
#             if [ ! -d "$CORRECT_HOME" ]; then
#                 CORRECT_HOME=""
#             fi
#         fi
#         # å¦‚æœè¿˜æ˜¯ä¸ç¡®å®šï¼Œå°è¯•å¸¸è§è·¯å¾„
#         if [ -z "$CORRECT_HOME" ] || [ ! -f "$CORRECT_HOME/.zshrc" ]; then
#             for test_home in "/c/Users/Administrator" "/d/Users/Administrator" "/e/Users/Administrator"; do
#                 if [ -d "$test_home" ] && [ -f "$test_home/.zshrc" ]; then
#                     CORRECT_HOME="$test_home"
#                     break
#                 fi
#             done
#         fi
#         # å¦‚æœæ‰¾åˆ°äº†æ­£ç¡®çš„ HOMEï¼Œä½¿ç”¨å®ƒå¯åŠ¨ zsh
#         # å…³é”®ï¼šåœ¨ exec å‘½ä»¤ä¸­ç›´æ¥è®¾ç½® HOME ç¯å¢ƒå˜é‡
#         if [ -n "$CORRECT_HOME" ] && [ -f "$CORRECT_HOME/.zshrc" ]; then
#             # ä½¿ç”¨ env å‘½ä»¤ç¡®ä¿ HOME è¢«æ­£ç¡®ä¼ é€’
#             exec env HOME="$CORRECT_HOME" zsh
#         else
#             # å¦‚æœæ‰¾ä¸åˆ°æ­£ç¡®çš„ HOMEï¼Œä»ç„¶å°è¯•å¯åŠ¨ zshï¼ˆå¯èƒ½ä¼šå¤±è´¥ï¼‰
#             exec zsh
#         fi
#     fi
# fi

# ============================================
# å¯åŠ¨é…ç½®ï¼ˆå¯é€‰ï¼‰
# ============================================

# è‡ªåŠ¨åˆ‡æ¢åˆ°é»˜è®¤ç›®å½•ï¼ˆå¯é€‰ï¼Œå·²æ³¨é‡Šï¼‰
# cd /d/Code || cd ~

# æ˜¾ç¤ºæ¬¢è¿ä¿¡æ¯ï¼ˆå¯é€‰ï¼Œå·²æ³¨é‡Šï¼‰
# echo "Welcome! ğŸ˜Š"

