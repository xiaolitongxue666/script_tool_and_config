{{- if or (eq .chezmoi.os "linux") (eq .chezmoi.os "darwin") (eq .chezmoi.os "windows") -}}
#!/bin/bash

# ============================================
# Neovim 安装脚本（chezmoi run_once_）
# 支持所有平台
# ============================================

# 获取 common_install.sh 路径
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="${CHEZMOI_PROJECT_ROOT:-$(cd "${SCRIPT_DIR}/../.." && pwd 2>/dev/null || echo "$HOME")}"
COMMON_INSTALL="${PROJECT_ROOT}/scripts/chezmoi/common_install.sh"

if [ ! -f "$COMMON_INSTALL" ]; then
    COMMON_INSTALL="$HOME/.local/share/chezmoi/scripts/chezmoi/common_install.sh"
fi

# 加载通用函数库
if [ -f "$COMMON_INSTALL" ]; then
    source "$COMMON_INSTALL"
else
    echo "[WARNING] 未找到 common_install.sh，使用基本函数"
    function setup_proxy() { :; }
    function detect_os_and_package_manager() {
        OS="$(uname -s)"
        if [[ "$OS" == "Darwin" ]]; then
            PLATFORM="macos"
            PACKAGE_MANAGER="brew"
        elif [[ "$OS" == "Linux" ]]; then
            PLATFORM="linux"
            if command -v pacman &> /dev/null; then
                PACKAGE_MANAGER="pacman"
            elif command -v apt-get &> /dev/null; then
                PACKAGE_MANAGER="apt"
            elif command -v dnf &> /dev/null; then
                PACKAGE_MANAGER="dnf"
            elif command -v yum &> /dev/null; then
                PACKAGE_MANAGER="yum"
            fi
        elif [[ "$OS" =~ ^(MINGW|MSYS|CYGWIN) ]]; then
            PLATFORM="windows"
            if command -v winget &> /dev/null; then
                PACKAGE_MANAGER="winget"
            elif command -v pacman.exe &> /dev/null; then
                PACKAGE_MANAGER="pacman"
            fi
        fi
    }
    function install_package() {
        local pkg="$1"
        if [[ "$PACKAGE_MANAGER" == "brew" ]]; then
            brew install "$pkg"
        elif [[ "$PACKAGE_MANAGER" == "pacman" ]]; then
            if [[ "$PLATFORM" == "windows" ]]; then
                pacman.exe -S --noconfirm "$pkg"
            else
                sudo pacman -S --noconfirm "$pkg"
            fi
        elif [[ "$PACKAGE_MANAGER" == "apt" ]]; then
            sudo apt-get update && sudo apt-get install -y "$pkg"
        elif [[ "$PACKAGE_MANAGER" == "dnf" ]]; then
            sudo dnf install -y "$pkg"
        elif [[ "$PACKAGE_MANAGER" == "yum" ]]; then
            sudo yum install -y "$pkg"
        elif [[ "$PACKAGE_MANAGER" == "winget" ]]; then
            winget install --id="$pkg" -e --accept-source-agreements --accept-package-agreements
        fi
    }
    # 无 common_install 时无法做版本检查，视为需要安装/升级
    function is_nvim_version_ge_0_11() { return 1; }
fi

# 设置代理
setup_proxy "${PROXY:-{{ env "http_proxy" | default "http://127.0.0.1:7890" }}}"

# 检测操作系统和包管理器
detect_os_and_package_manager || exit 1

# 检查 Neovim 是否已安装且版本 >= 0.11.0（本仓库配置要求）
if command -v nvim &> /dev/null && is_nvim_version_ge_0_11; then
    echo "[INFO] Neovim 已安装且满足版本要求 (>= 0.11.0): $(nvim --version | head -n 1)"
    exit 0
fi

# 未安装或版本过低，需要安装或升级
if command -v nvim &> /dev/null; then
    echo "[INFO] 当前 Neovim 版本低于 0.11.0，将尝试升级: $(nvim --version | head -n 1)"
else
    echo "[INFO] 开始安装 Neovim (需要 >= 0.11.0)..."
fi

# Neovim 0.11+ 官方 release 下载（Linux 回退用）
NEOVIM_RELEASE_VERSION="v0.11.5"
NEOVIM_RELEASE_BASE="https://github.com/neovim/neovim-releases/releases/download/${NEOVIM_RELEASE_VERSION}"

install_neovim_linux_tarball() {
    local dest_dir="${HOME}/.local/share/nvim-install"
    local bin_dir="${HOME}/.local/bin"
    mkdir -p "$dest_dir" "$bin_dir"
    local tarball="nvim-linux-x86_64.tar.gz"
    local url="${NEOVIM_RELEASE_BASE}/${tarball}"
    local tmp_file="${dest_dir}/${tarball}"
    echo "[INFO] 从 GitHub releases 下载 Neovim ${NEOVIM_RELEASE_VERSION} ..."
    if command -v curl &> /dev/null; then
        curl -sL -o "$tmp_file" "$url" || return 1
    elif command -v wget &> /dev/null; then
        wget -q -O "$tmp_file" "$url" || return 1
    else
        echo "[ERROR] 需要 curl 或 wget 下载"
        return 1
    fi
    tar xzf "$tmp_file" -C "$dest_dir" || return 1
    rm -f "$tmp_file"
    ln -sf "${dest_dir}/nvim-linux-x86_64/bin/nvim" "${bin_dir}/nvim"
    export PATH="${bin_dir}:${PATH}"
    echo "[INFO] 已安装到 ${bin_dir}/nvim，请确保 ${bin_dir} 在 PATH 中"
}

install_neovim_linux_deb() {
    local dest_dir="${HOME}/.local/share/nvim-install"
    mkdir -p "$dest_dir"
    local deb="nvim-linux-x86_64.deb"
    local url="${NEOVIM_RELEASE_BASE}/${deb}"
    local tmp_file="${dest_dir}/${deb}"
    echo "[INFO] 从 GitHub releases 下载 Neovim ${NEOVIM_RELEASE_VERSION} (.deb) ..."
    if command -v curl &> /dev/null; then
        curl -sL -o "$tmp_file" "$url" || return 1
    elif command -v wget &> /dev/null; then
        wget -q -O "$tmp_file" "$url" || return 1
    else
        echo "[ERROR] 需要 curl 或 wget 下载"
        return 1
    fi
    # 官方 .deb 与 Ubuntu/Debian 的 neovim/neovim-runtime 文件冲突，先移除再安装
    sudo apt-get remove -y neovim neovim-runtime 2>/dev/null || true
    sudo apt-get install -y "$tmp_file" || return 1
    rm -f "$tmp_file"
}

# 根据平台安装或升级 Neovim 到 0.11+
case "$PLATFORM" in
    macos)
        if [[ "$PACKAGE_MANAGER" == "brew" ]]; then
            if command -v nvim &> /dev/null; then
                brew upgrade neovim 2>/dev/null || brew install neovim
            else
                install_package "neovim"
            fi
        else
            echo "[ERROR] macOS 需要 Homebrew 来安装 Neovim"
            exit 1
        fi
        ;;
    linux)
        if [[ "$PACKAGE_MANAGER" == "pacman" ]]; then
            install_package "neovim" 2>/dev/null || true
            if ! is_nvim_version_ge_0_11; then
                install_neovim_linux_tarball || echo "[WARNING] tarball 安装失败，请手动从 https://github.com/neovim/neovim-releases/releases 安装 0.11+"
            fi
        elif [[ "$PACKAGE_MANAGER" == "apt" ]]; then
            if add-apt-repository -y ppa:neovim-ppa/unstable 2>/dev/null; then
                sudo apt-get update && sudo apt-get install -y neovim 2>/dev/null || true
            fi
            if ! is_nvim_version_ge_0_11; then
                install_package "neovim" 2>/dev/null || true
            fi
            if ! is_nvim_version_ge_0_11; then
                install_neovim_linux_deb || echo "[WARNING] .deb 安装失败，请手动安装 Neovim 0.11+"
            fi
        elif [[ "$PACKAGE_MANAGER" == "dnf" ]] || [[ "$PACKAGE_MANAGER" == "yum" ]]; then
            if [[ "$PACKAGE_MANAGER" == "yum" ]]; then
                install_package "neovim" 2>/dev/null || {
                    echo "[WARNING] 通过 yum 安装失败，可能需要启用 EPEL 仓库"
                }
            else
                install_package "neovim" 2>/dev/null || true
            fi
            if ! is_nvim_version_ge_0_11; then
                install_neovim_linux_tarball || echo "[WARNING] tarball 安装失败，请手动安装 Neovim 0.11+"
            fi
        fi
        ;;
    windows)
        if [[ "$PACKAGE_MANAGER" == "winget" ]]; then
            install_package "Neovim.Neovim" 2>/dev/null || true
        elif [[ "$PACKAGE_MANAGER" == "pacman" ]]; then
            install_package "neovim" 2>/dev/null || true
        fi
        if ! is_nvim_version_ge_0_11 2>/dev/null; then
            echo "[WARNING] 当前安装的 Neovim 可能低于 0.11.0，请从 https://github.com/neovim/neovim-releases/releases 手动安装 0.11+"
        fi
        ;;
    *)
        echo "[ERROR] 不支持的操作系统"
        exit 1
        ;;
esac

if is_nvim_version_ge_0_11; then
    echo "[SUCCESS] Neovim 安装/升级成功 (>= 0.11.0): $(nvim --version | head -n 1)"
    echo "[INFO] Neovim 配置文件位于: ~/.config/nvim/"
    echo "[INFO] 如果使用 Git Submodule 管理配置，请运行:"
    echo "       run_once_install-neovim-config 会将 nvim 克隆到 ~/.config/nvim"
else
    echo "[WARNING] Neovim 可能未正确安装或版本仍低于 0.11.0，请检查 PATH 或手动从 https://github.com/neovim/neovim-releases/releases 安装"
fi
{{- end -}}

